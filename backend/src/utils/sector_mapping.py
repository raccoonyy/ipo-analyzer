"""
Sector Mapping and Grouping
Maps detailed 38.co.kr sectors to broader categories
"""


def normalize_sector(sector: str) -> str:
    """Normalize sector name (fix spacing, typos, etc.)"""
    if not sector or sector == "N/A":
        return "기타"

    # Remove extra spaces
    sector = " ".join(sector.split())

    # Fix specific exact matches first
    exact_replacements = {
        "소프트웨어 개발 및 공급": "소프트웨어 개발 및 공급업",
        "기타 광학 기기 제조업": "기타 광학기기 제조업",
        "유인 항공기, 항공 우주선 및 보조장치 제조업": "유인 항공기, 항공우주선 및 보조장치 제조업",
        "일반 목적용 기계 제조업": "일반목적용 기계 제조업",
        "전동기, 발전기 및 전기 변환 · 공급 · 제어 장치": "전동기, 발전기 및 전기 변환 공급 제어 장치",
    }

    if sector in exact_replacements:
        return exact_replacements[sector]

    # Fix partial patterns
    patterns = {
        "응용 소프트웨어": "응용소프트웨어",
        "시스템 소프트웨어": "시스템소프트웨어",
        "영화, 비디오물, 방송 프로그램": "영화, 비디오물, 방송프로그램",
        "의료용품 및 기타 의약 관련제품": "의료용품 및 기타 의약관련제품",
        "의료용품 및 기타 의약품관련제품": "의료용품 및 기타 의약관련제품",
        "그 외 기타": "기타",
        "그외 기타": "기타",
    }

    for old, new in patterns.items():
        sector = sector.replace(old, new)

    return sector


# Sector grouping - maps normalized sectors to broader categories
SECTOR_GROUPS = {
    # 소프트웨어 & IT
    "소프트웨어": [
        "소프트웨어 개발 및 공급업",
        "응용소프트웨어 개발 및 공급업",
        "시스템소프트웨어 개발 및 공급업",
        "모바일 게임 소프트웨어 개발 및 공급업",
        "기타 소프트웨어 자문, 개발 및 공급업",
    ],
    "정보서비스": [
        "컴퓨터시스템 통합 자문 및 구축 서비스업",
        "컴퓨터 시스템 통합 자문 및 구축 서비스업",
        "데이터베이스 및 온라인 정보제공업",
        "기타 정보 서비스업",
        "정보서비스업",
    ],
    # 반도체 & 전자부품
    "반도체": [
        "반도체 제조업",
        "반도체 제조용 기계 제조업",
        "전자집적회로 제조업",
        "비메모리용 및 기타 전자집적회로 제조업",
        "평판디스플레이 제조용 기계 제조업",
        "액정 표시장치 제조업",
    ],
    "전자부품": [
        "전자부품 제조업",
        "기타 전자부품 제조업",
        "그 외 기타 전자부품 제조업",
        "전자부품 실장기판 제조업",
        "전자 부품 제조업",
        "전자 축전기 제조업",
        "전자축전기 제조업",
        "기타 주변기기 제조업",
    ],
    # 의약품 & 바이오
    "의약품": [
        "의약품 제조업",
        "완제 의약품 제조업",
        "기초 의약물질 및 생물학적 제제 제조업",
        "의약품 도매업",
        "바이오소재 및 혼합물 제조업",
    ],
    "의료기기": [
        "의료용 기기 제조업",
        "기타 의료용 기기 제조업",
        "그 외 기타 의료용 기기 제조업",
        "의료용품 및 기타 의약관련제품 제조업",
        "방사선 장치 및 전기식 진단 기기 제조업",
        "의료, 정밀 및 과학기기 도매업",
        "의료기기 및 화장품 제조",
    ],
    "바이오 연구개발": [
        "의학 및 약학 연구개발업",
        "물리, 화학 및 생물학 연구개발업",
        "자연과학 및 공학 연구개발업",
    ],
    # 기계 & 제조
    "특수목적용 기계": [
        "특수 목적용 기계 제조업",
        "기타 특수목적용 기계 제조업",
        "그 외 기타 특수 목적용 기계 제조업",
        "그 외 기타 특수목적용 기계 제조업",
        "그외 기타 특수목적용 기계 제조업",
    ],
    "일반목적용 기계": [
        "일반목적용 기계 제조업",
        "일반 목적용 기계 제조업",
        "산업용 로봇 제조업",
        "디지털 적층 성형기계 제조업",
    ],
    "금속가공": [
        "기타 금속 가공제품 제조업",
        "구조용 금속제품, 탱크 및 증기발생기 제조업",
        "기타 구조용 금속제품 제조업",
        "금속 주조업",
        "금속파스너 및 나사제품 제조업",
        "주형 및 금형 제조업",
        "1차 비철금속 제조업",
        "기타 1차 철강 제조업",
        "기타 비철금속 제련, 정련 및 합금 제조업",
    ],
    # 자동차
    "자동차 부품": [
        "자동차 부품 제조업",
        "자동차 신품 부품 제조업",
        "자동차 엔진용 부품 제조업",
        "자동차 차체 및 트레일러 제조업",
        "자동차용 신품 동력전달장치 제조업",
        "그 외 자동차용 신품 부품 제조업",
        "자동차 신품 부품 및 내장품 판매업",
    ],
    # 전기 & 에너지
    "전기장비": [
        "전동기 및 발전기 제조업",
        "전동기, 발전기 및 전기 변환 공급 제어 장치",
        "변압기 제조업",
        "전기 공급 및 제어장치 제조업",
        "기타 전기장비 제조업",
        "절연선 및 케이블 제조업",
        "기타 절연선 및 케이블 제조업",
        "일차전지 및 축전지 제조업",
    ],
    # 화학
    "화학제품": [
        "기초 화학물질 제조업",
        "기타 화학제품 제조업",
        "정밀 화학제품 제조업",
        "그 외 기타 분류 안된 화학제품 제조업",
        "합성수지 및 기타 플라스틱물질 제조업",
        "무기안료 및 기타금속산화물 제조업",
        "화장품 제조업",
    ],
    # 영상 & 콘텐츠
    "미디어 콘텐츠": [
        "영화, 비디오물, 방송프로그램 제작 및 배급업",
        "일반 영화 및 비디오물 제작업",
        "실감미디어, 엔터테인먼트",
        "만화 출판업",
        "서적, 잡지 및 기타 인쇄물 출판업",
        "광고 대행업",
    ],
    # 측정 & 정밀기기
    "정밀기기": [
        "기타 측정, 시험, 항해, 제어 및 정밀기기 제조업",
        "물질 검사, 측정 및 분석기구 제조업",
        "전자기 측정, 시험 및 분석기구 제조업",
        "레이더, 항행용 무선 기기 및 측량 기구 제조업",
        "물질 성분 검사 및 분석업",
        "기타 광학기기 제조업",
        "전자감지장치 제조업",
    ],
    # 금융
    "금융서비스": [
        "금융 지원 서비스업",
        "기타 금융 지원 서비스업",
        "그 외 기타 금융 지원 서비스업",
        "금융 및 보험관련 서비스업",
        "보험 및 연금관련 서비스업",
    ],
    "금융투자": [
        "기타 금융 투자업",
        "신탁업 및 집합 투자업",
        "기타 금융업",
        "그 외 기타 금융업",
        "그 외 기타 분류 안된 금융업",
        "여신 금융업",
        "보증 보험업",
    ],
    # 건설 & 부동산
    "건설": [
        "건물 건설업",
        "건물설비 설치 공사업",
        "기타 건물 관련설비 설치 공사업",
        "전기 및 통신 공사업",
        "건축기술, 엔지니어링 및 관련 기술 서비스업",
        "엔지니어링 서비스업",
        "기타 엔지니어링 서비스업",
    ],
    "부동산": [
        "부동산 임대업",
        "비주거용 건물 임대업",
        "비주거용 부동산 관리업",
        "(한화리츠)",
    ],
    # 기타 제조
    "플라스틱": [
        "1차 플라스틱제품 제조업",
        "플라스틱제품 제조업",
        "플라스틱 선, 봉, 관 및 호스 제조업",
    ],
    "통신장비": [
        "유선 통신장비 제조업",
        "무선 및 위성 통신업",
        "비디오 및 기타 영상 기기 제조업",
        "영상 및 음향기기 제조업",
    ],
    "운송장비": [
        "선박 구성 부분품 제조업",
        "선박 및 수상 부유 구조물 건조업",
        "유인 항공기, 항공우주선 및 보조장치 제조업",
        "무기 및 총포탄 제조업",
    ],
    # 서비스
    "전문서비스": [
        "기타 전문, 과학 및 기술 서비스업",
        "그 외 기타 분류 안된 전문, 과학 및 기술 서비스업",
        "그외 기타 분류안된 전문, 과학 및 기술 서비스업",
        "기타 과학기술 서비스업",
        "경영 컨설팅업",
        "환경컨설팅, 및 온실가스배출권매매 및 관련사업",
    ],
    "유통": [
        "상품 중개업",
        "기타 상품 전문 도매업",
        "생활용품 도매업",
        "주류 도매업",
    ],
    "소매": [
        "전자상거래 소매 중개업",
        "가구 소매업",
        "신발 소매업",
        "섬유, 의복, 신발 및 가죽제품 소매업",
    ],
}


def get_sector_group(sector: str) -> str:
    """
    Map a detailed sector to its broader category

    Args:
        sector: Original sector name from 38.co.kr

    Returns:
        Grouped sector category name
    """
    # First normalize the sector name
    normalized = normalize_sector(sector)

    # Check if it matches any group
    for group_name, sector_list in SECTOR_GROUPS.items():
        if normalized in sector_list:
            return group_name

    # Special handling for common patterns
    if "신규상장" in normalized:
        return "신규상장"
    if "기타" in normalized and "분류" in normalized:
        return "기타"
    if "금융" in normalized:
        return "금융서비스"
    if "제조업" in normalized and "기타" in normalized:
        return "기타 제조업"

    # Default: return normalized name
    return normalized


def get_all_sector_groups():
    """Get list of all sector group names"""
    return sorted(set(SECTOR_GROUPS.keys()) | {"신규상장", "기타", "기타 제조업"})
